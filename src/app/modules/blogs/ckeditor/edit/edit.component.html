<header *ngIf="blog">
  <minds-banner
    [object]="blog"
    [editMode]="true"
    (added)="add_banner($event)"
    [done]="banner_prompt"
  ></minds-banner>
</header>

<form (submit)="save()" class="m-blogEdit__form" *ngIf="blog.guid">
  <div class="m-blogEdit__topWrapper">
    <div class="m-blogEdit__titleArea">
      <minds-textarea
        name="title"
        [(mModel)]="blog.title"
        class="m-blogEdit__textArea"
        placeholder="Your title"
        i18n-placeholder="@@BLOGS__EDIT__TITLE_PLACEHOLDER"
      ></minds-textarea>
    </div>
    <!-- Owner box -->
    <div class="m-blogEdit__ownerBox">
      <div
        class="m-blogEdit__userAvatarWrapper"
        [hovercard]="session.getLoggedInUser().guid"
      >
        <a [routerLink]="['/', session.getLoggedInUser().username]">
          <img
            src="{{ minds.cdn_url }}icon/{{
              session.getLoggedInUser().guid
            }}/small/{{ session.getLoggedInUser().icontime }}"
            class="m-blogEdit__userAvatar"
          />
        </a>
      </div>
      <div class="m-blogEdit__body">
        <a
          [routerLink]="['/', session.getLoggedInUser().username]"
          class="m-blogEdit__username"
          >{{ session.getLoggedInUser().name }}</a
        >
        <span *ngIf="blog.time_created">{{
          blog.time_created * 1000 | date: 'medium'
        }}</span>
      </div>
    </div>
  </div>

  <div class="m-blogEdit__editorWrapper">
    <m-blog__editor
      (contentChanged)="onContentChange($event)"
      [content]="blog.description"
      placeholder="Go ahead and write some content!"
      i18n-placeholder="@@BLOGS__EDIT__INLINE_EDITOR_PLACEHOLDER"
      #inlineEditor
    ></m-blog__editor>
  </div>

  <div class="m-blogEdit__actions">
    <button
      type="submit"
      class="m-button m-button--text m-button--draft"
      *ngIf="!blog.published"
      [disabled]="!canSave || pendingUploads.length !== 0 || !validThreshold"
      i18n="@@BLOGS__EDIT__SAVE_DRAFT_ACTION"
    >
      Save draft
    </button>
    <button
      type="submit"
      class="m-button m-button--text m-button--submit"
      (click)="blog.published = 1"
      [disabled]="!canSave || pendingUploads.length !== 0 || !validThreshold"
      i18n="@@BLOGS__EDIT__PUBLISH_ACTION"
    >
      Publish
    </button>
    <div
      *ngIf="inProgress"
      class="m-wire--creator--submit-label mdl-spinner mdl-js-spinner is-active"
      [mdl]
    ></div>

    <ng-container *ngIf="error" [ngSwitch]="error">
      <h1
        class="m-blogEdit__actions--error"
        i18n="@@BLOGS__EDIT__NO_TITLE_ERROR"
        *ngSwitchCase="'error:no-title'"
      >
        Error: You must provide a title
      </h1>
      <h1
        class="m-blogEdit__actions--error"
        i18n="@@BLOGS__EDIT__NO_DESCRIPTION_ERROR"
        *ngSwitchCase="'error:no-description'"
      >
        Error: You must provide a description
      </h1>
      <h1
        class="m-blogEdit__actions--error"
        i18n="@@BLOGS__EDIT__NO_BANNER_ERROR"
        *ngSwitchCase="'error:no-banner'"
      >
        Error: You must upload a banner
      </h1>
      <h1
        class="m-blogEdit__actions--error"
        i18n="@@M__COMMON__ERROR_GATEWAY_TIMEOUT"
        *ngSwitchCase="'error:gateway-timeout'"
      >
        Error: Gateway Time-out
      </h1>
      <h1 class="m-blogEdit__actions--error" *ngSwitchDefault>
        Error: {{ error }}
      </h1>
    </ng-container>
  </div>

  <div class="m-blogEdit__optionsContainer">
    <div class="m-blogEdit__licenseInfo">
      <i class="material-icons">public</i>
      <select
        name="license"
        [ngModel]="blog.license"
        (change)="blog.license = $event.target.value"
        class="m-blogEdit__optionSelector"
      >
        <option value="" i18n="@@BLOGS__EDIT__LICENCE_PLACEHOLDER"
          >-- License --</option
        >
        <option *ngFor="let l of licenses" [value]="l.value">{{
          l.text
        }}</option>
      </select>
    </div>
    <div class="m-blogEdit__categoryInfo">
      <m-hashtags-selector
        #hashtagsSelector
        [tags]="blog.tags.slice(0)"
        (tagsChange)="onTagsChange($event)"
        (tagsAdded)="onTagsAdded($event)"
        (tagsRemoved)="onTagsRemoved($event)"
      ></m-hashtags-selector>
    </div>
    <div class="m-blogEdit__visibility">
      <i class="material-icons">visibility</i>
      <select
        name="access_id"
        [ngModel]="blog.access_id"
        (change)="blog.access_id = $event.target.value"
        class="m-blogEdit__optionSelector"
      >
        <option *ngFor="let a of access" [value]="a.value">{{ a.text }}</option>
      </select>
    </div>

    <m-nsfw-selector
      service="editing"
      (selectedChange)="onNSFWSelections($event)"
      [selected]="editing && blog.nsfw != [] ? blog.nsfw : []"
    >
    </m-nsfw-selector>

    <m-wire-threshold-input
      [(threshold)]="blog.wire_threshold"
      [(enabled)]="blog.paywall"
      (validThreshold)="validThreshold = $event"
      #thresholdInput
    ></m-wire-threshold-input>

    <ng-container *mIfFeature="'post-scheduler'">
      <m-poster-date-selector
        *ngIf="checkTimePublished()"
        [date]="getTimeCreated()"
        (dateChange)="onTimeCreatedChange($event)"
        (onError)="posterDateSelectorError($event)"
      ></m-poster-date-selector>
    </ng-container>
  </div>

  <div class="m-blogEdit__metaContainer" *ngIf="blog.custom_meta">
    <div class="m-blogEdit__toggleContainer">
      <span
        class="m-blogEdit__metaToggle--toggle"
        (click)="toggle.value = !toggle.value"
        #toggle
      >
        Metadata
        <i class="material-icons m-material-icons-inline" *ngIf="!toggle.value"
          >arrow_drop_down</i
        >
        <i class="material-icons m-material-icons-inline" *ngIf="toggle.value"
          >arrow_drop_up</i
        >
      </span>
    </div>

    <div class="m-blogEdit__metaFields" [hidden]="!toggle.value">
      <div class="m-blogEdit__metaField">
        <label i18n="@@BLOGS__EDIT__URL_SLUG">URL Slug</label>

        <input type="text" name="slug" [(ngModel)]="blog.slug" />
      </div>

      <div class="m-blogEdit__metaField">
        <label i18n="@@BLOGS__EDIT__META_TITLE">Meta Title</label>

        <input
          type="text"
          name="custom_meta_title"
          [(ngModel)]="blog.custom_meta.title"
        />
      </div>

      <div class="m-blogEdit__metaField">
        <label i18n="@@BLOGS__EDIT__META_DESCRIPTION">Meta Description</label>

        <textarea
          name="custom_meta_description"
          [(ngModel)]="blog.custom_meta.description"
        ></textarea>
      </div>

      <div class="m-blogEdit__metaField">
        <label i18n="@@BLOGS__EDIT__META_AUTHOR">Meta Author</label>

        <input
          type="text"
          name="custom_meta_author"
          [(ngModel)]="blog.custom_meta.author"
        />
      </div>
    </div>
  </div>
</form>
