<header *ngIf="blog">
  <minds-banner
    [object]="blog"
    [editMode]="true"
    (added)="add_banner($event)"
    [done]="banner_prompt"
  ></minds-banner>
</header>

<form (submit)="save()" style="max-width:740px" *ngIf="blog.guid">
  <div style="width: 100%">
    <div>
      <minds-textarea
        name="title"
        [(mModel)]="blog.title"
        placeholder="Your title"
        i18n-placeholder="@@BLOGS__EDIT__TITLE_PLACEHOLDER"
      ></minds-textarea>
    </div>
    <!-- Owner box -->
    <div>
      <div [hovercard]="session.getLoggedInUser().guid">
        <a [routerLink]="['/', session.getLoggedInUser().username]">
          <img
            src="{{cdnUrl}}icon/{{session.getLoggedInUser().guid}}/small/{{session.getLoggedInUser().icontime}}"
          />
        </a>
      </div>
      <div>
        <a [routerLink]="['/', session.getLoggedInUser().username]"
          >{{session.getLoggedInUser().name}}</a
        >
        <span *ngIf="blog.time_created"
          >{{ blog.time_created * 1000 | date: 'medium'}}</span
        >
      </div>
    </div>
  </div>

  <div>
    <ng-container *ngIf="!shouldUseCKEditor(); else newEditor">
      <m-inline-editor
        name="description"
        [(ngModel)]="blog.description"
        placeholder="Go ahead and write some content!"
        i18n-placeholder="@@BLOGS__EDIT__INLINE_EDITOR_PLACEHOLDER"
        #inlineEditor
      ></m-inline-editor>
    </ng-container>
    <ng-template #newEditor>
      <ng-container *mIfBrowser>
        <m-blog__editor
          (contentChanged)="onContentChange($event)"
          [content]="blog.description"
        ></m-blog__editor>
      </ng-container>
    </ng-template>
  </div>

  <div class="m-blogs__captcha">
    <label>
      <span>Captcha</span>
      <m-tooltip icon="help">
        Please enter the characters below to confirm that you are not a robot
      </m-tooltip>
    </label>
    <m-captcha name="blog-captcha" [(ngModel)]="captcha"></m-captcha>
  </div>

  <ng-template #menu>
    <ul data-cy="meatball-menu">
      <li>
        <m-dropdownMenu
          [menu]="licenseMenu"
          [anchorPosition]="{ top: '0' }"
          triggerClass="m-dropdownMenu__item"
          data-cy="meatball-menu-visibility"
        >
          <span>License</span>
          <m-icon iconId="chevron_right"></m-icon>
        </m-dropdownMenu>
      </li>

      <li>
        <m-dropdownMenu
          [menu]="visibilityMenu"
          [anchorPosition]="{ top: '0' }"
          triggerClass="m-dropdownMenu__item"
          data-cy="meatball-menu-visibility"
        >
          <span>Visibility</span>
          <m-icon iconId="chevron_right"></m-icon>
        </m-dropdownMenu>
      </li>
    </ul>
  </ng-template>

  <ng-template #licenseMenu>
    <ul data-cy="meatball-menu-license-menu">
      <li
        *ngFor="let licenseItem of licenseItems"
        (click)="setLicense(licenseItem.value)"
      >
        <span class="m-dropdownMenu__item">
          <span>{{ licenseItem.text }}</span>
          <m-icon
            iconId="check"
            *ngIf="blog.license === licenseItem.value"
          ></m-icon>
        </span>
      </li>
    </ul>
  </ng-template>

  <ng-template #visibilityMenu>
    <ul data-cy="meatball-menu-license-menu">
      <li
        *ngFor="let accessItem of accessItems"
        (click)="setAccessId(accessItem.value)"
      >
        <span>{{ accessItem.text }}</span>
        <m-icon
          iconId="check"
          *ngIf="blog.access_id === accessItem.value"
        ></m-icon>
      </li>
    </ul>
  </ng-template>

  <ng-template #paywallMenu>
    <ul data-cy="meatball-menu-license-menu">
      <m-wire-threshold-input
        [(threshold)]="blog.wire_threshold"
        [(enabled)]="blog.paywall"
        (validThreshold)="validThreshold = $event"
        #thresholdInput
      ></m-wire-threshold-input>
    </ul>
  </ng-template>

  <div
    class="mdl-cell mdl-cell--12-col m-additional-block mdl-color-text--blue-grey-200"
  >
    <div class="m-category-info">
      <m-hashtags-selector
        #hashtagsSelector
        [tags]="blog.tags.slice(0)"
        (tagsChange)="onTagsChange($event)"
        (tagsAdded)="onTagsAdded($event)"
        (tagsRemoved)="onTagsRemoved($event)"
      ></m-hashtags-selector>
    </div>

    <m-nsfw-selector
      service="editing"
      (selectedChange)="onNSFWSelections($event)"
      [selected]="editing && blog.nsfw != [] ? blog.nsfw : []"
    >
    </m-nsfw-selector>

    <m-wire-threshold-input
      [(threshold)]="blog.wire_threshold"
      [(enabled)]="blog.paywall"
      (validThreshold)="validThreshold = $event"
      #thresholdInput
    ></m-wire-threshold-input>

    <ng-container *mIfFeature="'post-scheduler'">
      <m-poster-date-selector
        *ngIf="checkTimePublished()"
        [date]="getTimeCreated()"
        (dateChange)="onTimeCreatedChange($event)"
        (onError)="posterDateSelectorError($event)"
      ></m-poster-date-selector>
    </ng-container>

    <button
      type="submit"
      *ngIf="!blog.published"
      [disabled]="!canSave || pendingUploads.length !== 0 || !validThreshold"
      i18n="@@BLOGS__EDIT__SAVE_DRAFT_ACTION"
    >
      Save draft
    </button>
    <m-button
      class="m-composerToolbar__action"
      [disabled]="
          (inProgress$ | async) || (isPosting$ | async) || !(canPost$ | async)
        "
      [dropdown]="postButtonDropdown"
      [dropdownAnchorPosition]="{ top: '100%', right: '0' }"
      (onAction)="onPost($event)"
      data-cy="post-button"
    >
      <ng-container
        *ngIf="!(isEditing$ | async); else isEditingButtonText"
        i18n="verb|@@COMMON__POST"
        >Post</ng-container
      >
      <ng-template #isEditingButtonText
        ><ng-container i18n="@@COMMON__SAVE">Save</ng-container></ng-template
      >
    </m-button>

    <button
      type="submit"
      (click)="blog.published = 1"
      [disabled]="!canSave || pendingUploads.length !== 0 || !validThreshold"
      i18n="@@BLOGS__EDIT__PUBLISH_ACTION"
    >
      Publish
    </button>
    <div
      *ngIf="inProgress"
      class="m-wire--creator--submit-label mdl-spinner mdl-js-spinner is-active"
      [mdl]
    ></div>

    <m-dropdownMenu
      triggerClass="m-composerTitleBar__menuButton"
      menuClass="m-composerTitleBar__menu"
      [anchorPosition]="{ top: '0', left: '0' }"
      [menu]="menu"
      [hidden]="inProgress"
      data-cy="meatball-menu-trigger"
    >
      <m-icon iconId="more_vert"></m-icon>
    </m-dropdownMenu>
  </div>
  <div *ngIf="blog.custom_meta">
    <div class="m-blog-edit--toggle-wrapper">
      <span (click)="toggle.value = !toggle.value" #toggle>
        Metadata
        <i class="material-icons m-material-icons-inline" *ngIf="!toggle.value"
          >arrow_drop_down</i
        >
        <i class="material-icons m-material-icons-inline" *ngIf="toggle.value"
          >arrow_drop_up</i
        >
      </span>
    </div>

    <div class="m-blog-edit--fields" [hidden]="!toggle.value">
      <div class="m-blog-edit--field">
        <label i18n="@@BLOGS__EDIT__URL_SLUG">URL Slug</label>

        <input type="text" name="slug" [(ngModel)]="blog.slug" />
      </div>

      <div class="m-blog-edit--field">
        <label i18n="@@BLOGS__EDIT__META_TITLE">Meta Title</label>

        <input
          type="text"
          name="custom_meta_title"
          [(ngModel)]="blog.custom_meta.title"
        />
      </div>

      <div class="m-blog-edit--field">
        <label i18n="@@BLOGS__EDIT__META_DESCRIPTION">Meta Description</label>

        <textarea
          name="custom_meta_description"
          [(ngModel)]="blog.custom_meta.description"
        ></textarea>
      </div>

      <div class="m-blog-edit--field">
        <label i18n="@@BLOGS__EDIT__META_AUTHOR">Meta Author</label>

        <input
          type="text"
          name="custom_meta_author"
          [(ngModel)]="blog.custom_meta.author"
        />
      </div>
    </div>
  </div>
</form>
